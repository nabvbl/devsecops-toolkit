name: python-security-ci

on:
  workflow_call:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  secrets-scan:
    name: Gitleaks (secrets scan)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            detect
            --source .
            --no-git
            --redact
            --config .gitleaks.toml

  test:
    name: Ruff + Pytest
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            app/requirements.txt
            requirements.txt
            pyproject.toml

      - name: Install (if requirements exist)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f "app/requirements.txt" ]]; then
            pip install -r app/requirements.txt
          elif [[ -f "requirements.txt" ]]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found (skipping dependency install)."
          fi
          pip install pytest ruff

      - name: Lint (ruff)
        run: ruff check .

      - name: Tests (only if tests exist)
        run: |
          set -euo pipefail
          if [[ -d "tests" ]] || compgen -G "test*.py" > /dev/null; then
            pytest -q
          else
            echo "No tests found (skipping)."
          fi

  semgrep:
    name: Semgrep (SAST)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Semgrep scan
        uses: semgrep/semgrep-action@v1
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        with:
          config: p/ci

  trivy_fs:
    name: Trivy FS (deps + config)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL
          exit-code: "1"
          ignore-unfixed: true
          cache-dir: .trivy-cache

  build_and_scan_image:
    name: Docker build + Trivy image + SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: dockerfile
        run: |
          if [[ -f "Dockerfile" ]]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build image (if Dockerfile exists)
        if: steps.dockerfile.outputs.present == 'true'
        run: docker build -t app:ci .

      - name: Trivy image scan (if Dockerfile exists)
        if: steps.dockerfile.outputs.present == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: app:ci
          format: table
          severity: HIGH,CRITICAL
          exit-code: "1"
          ignore-unfixed: true
          cache-dir: .trivy-cache

      - name: Generate SBOM (CycloneDX) (if Dockerfile exists)
        if: steps.dockerfile.outputs.present == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: image
          image-ref: app:ci
          format: cyclonedx
          output: sbom.cdx.json

      - name: Upload SBOM artifact (if Dockerfile exists)
        if: steps.dockerfile.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json
          if-no-files-found: error
